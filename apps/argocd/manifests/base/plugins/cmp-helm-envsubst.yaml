---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cmp-helm-envsubst
  namespace: argocd
  labels:
    argocd.argoproj.io/config-management-plugin: helm-envsubst-v1
data:
  plugin.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: ConfigManagementPlugin
    metadata:
      name: helm-envsubst
    spec:
      version: v1
      init:
        command: ["sh","-c"]
        args: ["helm dependency build {{ .path }}"]
      generate:
        command: ["sh","-c"]
        args: ["helm template $ARGOCD_APP_NAME {{ .path }} --namespace $ARGOCD_APP_NAMESPACE | envsubst"]
